"use strict";
/*! vc.js */window.VC={install:function install(Vue,options){var debug=options.debug;Vue.vc={_beforeExec:function(e){return new Promise(function(t,r){var n=e._vc;n.beforeExec?(e.event="result_"+Math.round(1e6*Math.random()),n.vm.$once(e.event,function(e){e?t(e):r(new Error("Canceled By User"))}),_modal(e,"beforeExec")):t(e)})},_execExternal:function(e){return new Promise(function(t,r){var n=new XMLHttpRequest,o=e._vc;n.open(e.method,e.url),"POST"===e.method&&(n.setRequestHeader("Content-Type","application/json"),e.data=JSON.stringify(e.data)),n.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.onload=function(){if(200===n.status){var e=n.responseText;t(o?{result:e,_vc:o}:e)}else{var a=new Error(n.statusText);a.code=n.status,r({error:a,_vc:o})}},n.onerror=function(){r({error:new Error("Network Error"),_vc:o})},n.send(e.data)})},_execLocal:function(e){return new Promise(function(t,r){var n=e._vc,o=e.url.split("//")[1].split("/"),a=localStorage.getItem(o[0]),s=o[1],c=a?JSON.parse(a):{},i=Array.isArray(c);switch(e.method){case"INIT":c=a?c:n.storage[n.property];break;case"CREATE":i?c.push(e.data):c[s]=e.data;break;case"UPDATE":s?c[s]=e.data:c=e.data;break;case"DELETE":i?c.splice(+s,1):delete c[s];break;default:r({error:new Error("execLocal unsupported method Error"),_vc:n})}i&&n.sort&&c.sort(n.sort),localStorage.setItem(o[0],JSON.stringify(c)),t(n?{result:c,_vc:n}:c)})},_parseJSON:function(e){return new Promise(function(t,r){var n=e._vc,o=n?e.result:e;try{var a=JSON.parse(o);t(n?{result:a,_vc:n}:a)}catch(e){r({error:new Error("JSON Parse Error"),_vc:n})}})},_parseVC:function _parseVC(details){return new Promise(function(resolve,reject){try{var result=eval(details.match(/(?:<script>)([\s\S]*)(?=<\/script>)/m)[1]);result.template=result.template||details.match(/(?:<template>)([\s\S]*)(?=<\/template>)/m)[1],resolve(result)}catch(e){reject(new Error("Vue Component Parse Error"))}})},_onGet:function(e){return new Promise(function(t,r){var n=e._vc;n.storage&&n.property?(n.storage[n.property]=e.result,t(e)):r(new Error("Store Result Error"))})},_afterExec:function(e){var t=e._vc;t.afterExec&&(e.route=t.afterExec.route,e.data=t.afterExec.data,_route(e))},_catch:function(e){debug&&console.log("Vue.vc",e)},upExternal:function(e){this._beforeExec(e).then(this._execExternal).then(this._parseJSON).then(this._onGet).then(this._afterExec).catch(this._catch)},upLocal:function(e){this._beforeExec(e).then(this._execLocal).then(this._onGet).then(this._afterExec).catch(this._catch)}};var vc=options.vc||[],base,routes,track,view={content:"none",config:{},modal:"none"},modal={};function _update(e){if(e.url){var t=~e.url.indexOf("local://")?"upLocal":"upExternal";e._vc.vm=this.$root,Vue.vc[t](e)}else _modal(e)}function _response(e){view.modal="none",e.event&&e._vc.vm.$emit(e.event,e)}function _modal(e,t){var r=t?e._vc[t]:e;e.ui=e.ui||r.ui,modal=e,view.modal=r.vc}if(Vue.mixin({data:function(){return{vc:{view:view,modal:modal}}},methods:{update:_update,response:_response}}),options.hasOwnProperty("routes")){var _route2=function(e){var t=JSON.parse(JSON.stringify(routes.list[routes.map[e.route.name]]));document.title=t.title||e.data&&e.data.title||document.title,t.details=e.route,t.title=document.title,e.data&&(t.path=t.prm?_parsePath(t.origin,e.route.prm):t.origin,history.pushState(t,null,t.path),track&&track(t)),routes.current=e.route,view.content===t.vc?(view.content="none",setTimeout(function(){view.content=t.vc,view.config=t.config},0)):(view.content=t.vc,view.config=t.config)},_parseRoutes=function e(t,r){var n,o;for(n=0;n<t.length;n++)o=_convertRoute(t[n],r),routes.map[o.name]=routes.list.length,routes.list.push(o),vc.push(o.vc),t[n].items&&e(t[n].items,t[n].name)},_convertRoute=function(e,t){var r={name:e.name,origin:base+e.path,vc:e.vc,title:e.title};return r.path=r.origin.replace(/\[([a-zA-Z0-9_]+)]/g,function(){return r.prm=r.prm||[],r.prm.push(arguments[1]),"([a-zA-Z0-9_]+)"}),t&&(r.parent=t),e.nav&&(r.nav=e.nav.name||e.name,r.ind=e.nav.ind),r.config=e.config||{},r},_detectRoute=function(){var e,t,r,n={name:routes.list[0].name},o="//"+window.location.host+window.location.pathname;for(e=0;e<routes.list.length;e++)(r=routes.list[e]).parent&&r.parent!==n.name||(t=new RegExp("^"+r.path+"(?![^/])","g"),o.replace(t,function(){if(arguments.length<4)delete n.prm;else{n.prm={};for(var e=1;e<arguments.length-2;e++)n.prm[r.prm[e-1]]=arguments[e]}return n.name=r.name,""}));return n},_parsePath=function(e,t){if(!t)return e;var r,n;for(r in t)t.hasOwnProperty(r)&&(n=new RegExp("\\["+r+"]"),e=e.replace(n,t[r]));return e};options.routes.callback&&(track=function(e){try{options.routes.callback(e)}catch(e){debug&&console.log(e)}}),base="//"+location.href.split("?")[0].split("/")[2]+(options.routes.base||""),routes={list:[],map:{}},_parseRoutes(options.routes.items),routes.nav=routes.list.filter(function(e){return!!e.nav}).sort(function(e,t){return e.ind-t.ind}),routes.current=_detectRoute(),Vue.component("vc-link",{name:"vc-link",props:["to","prm"],render:function(e){var t=this,r=routes.list[routes.map[t.to]].origin;return t.prm&&(r=_parsePath(r,t.prm)),e("a",{attrs:{href:r},on:{click:function(e){e.preventDefault(),t.route({route:{name:t.to,prm:t.prm||{}},data:{}})}}},this.$slots.default)}}),window.addEventListener("popstate",function(e){e.state&&(_route2({route:routes.current=e.state.details}),track&&track(e.state))},!1),Vue.mixin({data:function(){return{vc:{routes:routes}}},methods:{route:_route2}})}Vue.component("none",{name:"none",render:function(e){return e("div",{},this.$slots.default)}}),options.hasOwnProperty("url")&&function(){for(var e=options.url.prefix||"",t=options.url.postfix||"",r=function(r){Vue.component(vc[r],function(n,o){Vue.vc._execExternal({method:"GET",url:e+vc[r]+t}).then(Vue.vc._parseVC).then(n,o)})},n=0;n<vc.length;n++)r(n);if(options.hasOwnProperty("app")){var o=options.app;Vue.vc._execExternal({method:"GET",url:e+o+t}).then(Vue.vc._parseVC).then(function(e){new Vue(e).$mount(o)})}else options.hasOwnProperty("scope")?new Vue({el:options.scope}):console.log("vc target undefined")}()}};